<link rel="import" href="../polymer/polymer.html">
<dom-module id="uke-chord">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
    <svg id="ukeChordSvg" width="90" height="112" viewBox="0 0 90 112"
         style="font-family: sans-serif; font-size: 11px;"
         xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink">
      <title>[[title]] chord | http://pianosnake.github.io/uke-chord/</title>
      <text id="chordName" x="42" y="16" text-anchor="middle" style="font-size: 16px;"></text>
      <g id="svgChord" transform="translate(19,12)">
        <text id="position" x="-14" y="17" text-anchor="middle"></text>
        <rect id="nut" height="4" width="62" fill="black" style="visibility: hidden;"/>
        <g id="diamond" style="visibility:hidden;">
          <rect width="14" height="14" transform="translate(0,-10),rotate(45)"></rect>
        </g>
        <g id="strings" transform="translate(0,2)">
          <rect height="80" width="2" x="0"  fill="black"/>
          <rect height="80" width="2" x="20" fill="black"/>
          <rect height="80" width="2" x="40" fill="black"/>
          <rect height="80" width="2" x="60" fill="black"/>
        </g>
        <g id="frets" transform="translate(0,2)">
          <rect height="2" width="62" y="0"  fill="black"/>
          <rect height="2" width="62" y="20" fill="black"/>
          <rect height="2" width="62" y="40" fill="black"/>
          <rect height="2" width="62" y="60" fill="black"/>
          <rect height="2" width="62" y="80" fill="black"/>
        </g>
        <g id="closedStrings" transform="translate(1,13)">
          <g id=closedString0 style="visibility: hidden;">
            <circle r="6"/>
            <text fill="white" id="finger0" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString1" style="visibility: hidden;">
            <circle r="6"/>
            <text fill="white" id="finger1" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString2" style="visibility: hidden;">
            <circle r="6"/>
            <text fill="white" id="finger2" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString3" style="visibility: hidden;">
            <circle r="6"/>
            <text fill="white" id="finger3" y="4" text-anchor="middle"></text>
          </g>
        </g>
        <g id="openStrings" transform="translate(1,-5)">
          <circle id="openString0" cx="0"  r="4" fill="none" stroke="black" stroke-width="1" style="visibility: hidden;"/>
          <circle id="openString1" cx="20" r="4" fill="none" stroke="black" stroke-width="1" style="visibility: hidden;"/>
          <circle id="openString2" cx="40" r="4" fill="none" stroke="black" stroke-width="1" style="visibility: hidden;"/>
          <circle id="openString3" cx="60" r="4" fill="none" stroke="black" stroke-width="1" style="visibility: hidden;"/>
        </g>
        <g id="subText" transform="translate(1,98)">
          <text id="subText0" x="0" text-anchor="middle"></text>
          <text id="subText1" x="20" text-anchor="middle"></text>
          <text id="subText2" x="40" text-anchor="middle"></text>
          <text id="subText3" x="60" text-anchor="middle"></text>
        </g>
      </g>
    </svg>

    <img src=[[imgSrc]]>
  </template>
  <script>
    (function(){
      var stringsNum = 4;

      Polymer({
        is: "uke-chord",
        properties: {
          frets: String,
          fingers: String,
          name: String,
          sub: String,
          position: String,
          size: String,
          r: String
        },

        attached: function(){
          this.parseFrets();
          this.parseFingers();
          this.showPosition();
          this.parseSub();
          this.showName();
          this.setSize();
          this.setRoot();

          //Manipulate the SVG and then dump it all in the img tag as base64
          var html = this.$.ukeChordSvg.outerHTML;
          //works precicely because 'unescape' is buggy
          this.imgSrc = 'data:image/svg+xml;base64,'+ btoa(unescape(encodeURIComponent(html)));
          Polymer.dom(this.root).removeChild(this.$.ukeChordSvg);
        },

        showPosition: function(){
          var position = parseInt(this.position);
          if(position === 0){
            this.$.nut.style.visibility = "visible";
          }else if(position > 0 && position < 100){
            this.$.position.innerHTML = position;
          }
        },

        _translate: function(x, y, el){
          el.setAttribute("transform", "translate("+x+","+y+")");
        },

        showName: function(){
          if(this.name && this.name.length > 0){
            this._translate(16, 28, this.$.svgChord);
            this.$.chordName.innerHTML = this.name;
            this.$.ukeChordSvg.setAttribute("height", 134);
            this.$.ukeChordSvg.setAttribute("viewBox", "0 0 84 134");
            this.title = this.name;
          }else{
            this.title = "Ukulele";
          }
        },

        parseFrets: function(){
          var frets;
          if(!this.frets) return;
          frets = this.frets.split("");
          if(frets.length !== stringsNum) return;
          frets.forEach(function(fret, idx){

            if(fret === "0"){
              this.$["openString" + idx].style.visibility = "visible";
            }else{
              this.$["closedString" + idx].style.visibility = "visible";
            }

            this._translate(idx * 20, (fret - 1) * 20, this.$["closedString" + idx]);

          }.bind(this));
        },

        parseFingers: function(){
          var fingers;
          if(!this.fingers) return;
          fingers = this.fingers.split("");
          if(fingers.length !== stringsNum) return;
          fingers.forEach(function(finger, idx){
            this.$["finger" + idx].innerHTML = finger !== "0" ? finger : "";
          }.bind(this));
        },

        parseSub: function(){
          var subText;
          if(!this.sub) return;

          //if using commas in the sub text as separators
          if(this.sub.indexOf(",")>0){
            subText = this.sub.split(",");
          }else{
            subText = this.sub.split("");
          }
          if(subText.length !== stringsNum) return;

          subText.forEach(function(text, idx){
            this.$["subText" + idx].innerHTML = text !== "_" ? text : "";
          }.bind(this));
        },

        setSize: function(){
          if(!this.size) return;
          if(this.size === "L" || this.size === "l"){
            this.$.ukeChordSvg.setAttribute("width", 180);
            if(this.name){
              this.$.ukeChordSvg.setAttribute("height", 268);
            }else{
              this.$.ukeChordSvg.setAttribute("height", 224);
            }
          }
        },

        setRoot: function(){
          if(!this.r) return;
          var roots = this.r.split("");

          roots.forEach(function(root){
            root = parseInt(root);
            if(root > stringsNum || root < 1) return;
            var stringIdx = stringsNum - root;
            var string = this.$["closedString" + stringIdx];
            var circle = this.$["closedString" + stringIdx].getElementsByTagName("circle")[0];
            var diamond = this.$.diamond.cloneNode(true);
            diamond.style.visibility = "visible";
            Polymer.dom(string).insertBefore(diamond, circle);
            Polymer.dom(string).removeChild(circle);
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
