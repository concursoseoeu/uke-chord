<link rel="import" href="../polymer/polymer.html">
<dom-module id="uke-chord">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      .hidden {
        visibility: hidden;
      }
      #ukeChordSvg #subText, #ukeChordSvg #closedStrings {
        font-family: sans-serif;
        font-size: 11px;
      }
      #ukeChordSvg #chordName{
        font-size: 16px;
      }
    </style>
    <svg id="ukeChordSvg" width="84" height="112" viewBox="0 0 84 112" xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink">
      <text id="chordName" x="42" y="16" text-anchor="middle"></text>
      <g id="svgChord" transform="translate(9,12)">

        <rect id="nut" height="4" width="62" fill="black"/>
        <g id="diamond" class="hidden">
          <rect width="14" height="14" transform="translate(0,-10),rotate(45)"></rect>
        </g>
        <g id="strings" transform="translate(0,2)">
          <rect height="80" width="2" x="0"  fill="black"/>
          <rect height="80" width="2" x="20" fill="black"/>
          <rect height="80" width="2" x="40" fill="black"/>
          <rect height="80" width="2" x="60" fill="black"/>
        </g>
        <g id="frets" transform="translate(0,2)">
          <rect height="2" width="62" y="0"  fill="black"/>
          <rect height="2" width="62" y="20" fill="black"/>
          <rect height="2" width="62" y="40" fill="black"/>
          <rect height="2" width="62" y="60" fill="black"/>
          <rect height="2" width="62" y="80" fill="black"/>
        </g>
        <g id="closedStrings" transform="translate(1,13)">
          <g id=closedString0>
            <circle r="6"/>
            <text fill="white" id="finger0" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString1">
            <circle r="6"/>
            <text fill="white" id="finger1" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString2">
            <circle r="6"/>
            <text fill="white" id="finger2" y="4" text-anchor="middle"></text>
          </g>
          <g id="closedString3">
            <circle r="6"/>
            <text fill="white" id="finger3" y="4" text-anchor="middle"></text>
          </g>
        </g>
        <g id="openStrings" transform="translate(1,-5)">
          <circle id="openString0" cx="0"  r="4" fill="none" stroke="black" stroke-width="1"/>
          <circle id="openString1" cx="20" r="4" fill="none" stroke="black" stroke-width="1"/>
          <circle id="openString2" cx="40" r="4" fill="none" stroke="black" stroke-width="1"/>
          <circle id="openString3" cx="60" r="4" fill="none" stroke="black" stroke-width="1"/>
        </g>
        <g id="subText" transform="translate(1,98)">
          <text id="subText0" x="0" text-anchor="middle"></text>
          <text id="subText1" x="20" text-anchor="middle"></text>
          <text id="subText2" x="40" text-anchor="middle"></text>
          <text id="subText3" x="60" text-anchor="middle"></text>
        </g>
      </g>
    </svg>
  </template>
  <script>
    (function(){
      var stringsNum = 4;

      Polymer({
        is: "uke-chord",
        properties: {
          frets: String,
          fingers: String,
          name: String,
          sub: String,
          nut: Boolean,
          size: String,
          r: String
        },
        attached: function(){
          this.parseFrets();
          this.parseFingers();
          this.showNut();
          this.parseSub();
          this.showName();
          this.setSize();
          this.setRoot();
        },

        showNut: function(){
          if(!this.nut){
            this.toggleClass("hidden", !this.nut, this.$.nut);
          }
        },

        _translate: function(x, y, el){
          el.setAttribute("transform", "translate("+x+","+y+")");
        },

        showName: function(){
          if(this.name){
            this._translate(9, 28, this.$.svgChord);
            this.$.chordName.innerHTML = this.name;
            this.$.ukeChordSvg.setAttribute("height", 134);
            this.$.ukeChordSvg.setAttribute("viewBox", "0 0 84 134");
          }
        },

        parseFrets: function(){
          var frets;
          if(!this.frets) return;
          frets = this.frets.split("");
          if(frets.length !== stringsNum) return;
          frets.forEach(function(fret, idx){
            this.toggleClass("hidden", fret !== "0", this.$["openString" + idx]);
            this.toggleClass("hidden", fret === "0", this.$["closedString" + idx]);
            this._translate(idx * 20, (fret - 1) * 20, this.$["closedString" + idx]);

          }.bind(this));
        },

        parseFingers: function(){
          var fingers;
          if(!this.fingers) return;
          fingers = this.fingers.split("");
          if(fingers.length !== stringsNum) return;
          fingers.forEach(function(finger, idx){
            this.$["finger" + idx].innerHTML = finger !== "0" ? finger : "";
          }.bind(this));
        },

        parseSub: function(){
          var subText;
          if(!this.sub) return;

          //if using commas in the sub text as separators
          if(this.sub.indexOf(",")>0){
            subText = this.sub.split(",");
          }else{
            subText = this.sub.split("");
          }
          if(subText.length !== stringsNum) return;

          subText.forEach(function(text, idx){
            this.$["subText" + idx].innerHTML = text !== "_" ? text : "";
          }.bind(this));
        },

        setSize: function(){
          if(!this.size) return;
          if(this.size === "L" || this.size === "l"){
            this.$.ukeChordSvg.setAttribute("width", 168);
            if(this.name){
              this.$.ukeChordSvg.setAttribute("height", 268);
            }else{
              this.$.ukeChordSvg.setAttribute("height", 224);
            }
          }
        },

        setRoot: function(){
          if(!this.r) return;
          var roots = this.r.split("");

          roots.forEach(function(root){
            root = parseInt(root);
            if(root > stringsNum || root < 1) return;
            var stringIdx = stringsNum - root;
            var string = this.$["closedString" + stringIdx];
            var circle = this.$["closedString" + stringIdx].getElementsByTagName("circle")[0];
            var diamond = this.$.diamond.cloneNode(true);
            this.toggleClass("hidden", false, diamond);
            string.insertBefore(diamond, circle);
            string.removeChild(circle);
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>